<!DOCTYPE html>
<html>
    <head>
        <title>mymy</title>
        <link rel="stylesheet" th:href="@{/cssjs/signup.css}">
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    </head>

            <div class="barright">
                <div class="join">
                    <button th:if="${email == null}">íšŒì›ê°€ì…</button>
                </div>
                <div class="login" id="login-logout">
                    <button id="login-button" th:if="${email == null}" onclick="loginOrLogin()">ë¡œê·¸ì¸</button>

                    <button id="login-button" th:if="${email != null}" onclick="loginOrLogout()">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            </div>
        </div>
    </div>
    

    <div class="signupcontainer">
        <div class="signup-head">
            <h2>íšŒì›ê°€ì…</h2>
            <!-- <img class="logo" src="./images/images2/logo-naver.png"> -->
            <a href="/">
                <button type="button" class="btn-h" id="homeButton">ğŸ </button>
            </a>
            <div>
            </div>
        </div>
        <form id="signupForm" action="/signup" method="post">
            <!-- ì´ˆê¸°ì—ëŠ” Email ì…ë ¥ í•„ë“œì™€ "ì¸ì¦ì½”ë“œ" ì…ë ¥ í•„ë“œë¥¼ ìˆ¨ê¹€ -->

            <h1>
            <label for="email" id="emailLabel">Email:</label>
            <input type="text" class="email" name="email" id="email" placeholder="ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”"
                onkeyup="validateEmail()">
            <div class="ebox">
                <div id="email-error" class="error-message"></div>
                <div id="email-success" class="success-message"></div>
            </div>

            <button type="button" class="btn-e" id="emailcheckButton" onclick="emailcheck()">ì¸ì¦ì½”ë“œ ì „ì†¡</button>
            <div id="result2"></div>
            <label for="echeck" id="echeckLabel">ì¸ì¦ì½”ë“œ:</label>
            <input type="text" id="echeck" name="echeck" onkeyup="validateEcheck()" style="display: none;">
            <div id="echeck-error" class="error-message"></div>
            <div id="echeck-success" class="success-message"></div>


            <label for="pw" class="pwbox">Password:</label>
            <input type="password" class="pw" name="pw" required title="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”" onkeyup="validatePw()"
                placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”">
            <div id="pw-error" class="error-message"></div>
            <div id="pw-success" class="success-message"></div>
            <label for="confirmPw" class="confirmPw">ë¹„ë°€ë²ˆí˜¸ í™•ì¸:</label>
        <input type="password" class="pw" name="confirmPw" id="confirmPw" onkeyup="validateConfirmPw()" required>
        <div id="confirmPw-error" class="error-message"></div>

            <label for="name" class="namebox">Name:</label>
            <input type="text" class="name" name="name" id="name" placeholder="ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”">
            <div></div>
            <label for="phone" class="phonebox">Phone Number:</label>
            <input type="text" class="phone" name="phone" id="phone" placeholder="í•¸ë“œí° ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”"
                oninput="this.value = this.value.replace(/[^0-9]/g, ''); validatePhone();" maxlength="11">
            <div id="phone-error" class="error-message"></div>

            <ul> 
                <li><span id="bdbox">
                Birthday: 
                </span></li>
                    
            <li class="birthdetail">
                <label for="birth" class="birthbox">
                <input type="text" class="birth" name="yy" placeholder="yy"
                    oninput="this.value = this.value.replace(/[^0-9]/g, ''); updateBirth();" maxlength="4">
                <!-- <br> -->
                <input type="text" class="birth" name="mm" placeholder="mm"
                    oninput="this.value = this.value.replace(/[^0-9]/g, ''); updateBirth();" maxlength="2"
                    onblur="validateMonth(this);">
                <!-- <br> -->
                <input type="text" class="birth" name="dd" placeholder="dd"
                    oninput="this.value = this.value.replace(/[^0-9]/g, '');validateDay(this, event); updateBirth();"
                    maxlength="2" onblur="validateDay(this);">
            </li>

        </label>
        </ul>
            <li>
                <h1 id="birth" name="birth">ìƒë…„ì›”ì¼: </h1>
            </li>

            <button type="button" class="btn" id="signupButton" disabled>Sign Up</button>
            <div id="result"></div>
            <input type="hidden" value=0 id="securitycode">
        </h1>
        </form>
    </div>



    <script>
        
        const securitycode = document.getElementById("securitycode");
        async function emailcheck() {
            document.getElementById("emailLabel").style.display = "block";
            document.getElementById("email").style.display = "block";
            document.getElementById("email-error").style.display = "block";
            document.getElementById("email-success").style.display = "block";
            document.getElementById("echeckLabel").style.display = "block";
            document.getElementById("echeck").style.display = "block";
            document.getElementById("echeck-error").style.display = "block";
            document.getElementById("echeck-success").style.display = "block";


            const toEmail = document.querySelector('#email');
            const echeck = document.querySelector('#echeck');
            const emailSuccessMessage = document.getElementById('email-success');
            const data = { email: toEmail.value }; // POST ìš”ì²­ìœ¼ë¡œ ë³´ë‚¼ ë°ì´í„°
            console.log(echeck.value);
            console.log(toEmail.value);
            try {
                const response = await fetch('/emailcheck', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data), // ë°ì´í„°ë¥¼ JSON ë¬¸ìì—´ë¡œ ë³€í™˜
                });

                if (response.ok) {
                    // ì„œë²„ ì‘ë‹µì´ ì„±ê³µì ì¸ ê²½ìš°ì˜ ì²˜ë¦¬
                    const result2 = await response.text(); // ì„œë²„ë¡œë¶€í„°ì˜ ì‘ë‹µì„ í…ìŠ¤íŠ¸ë¡œ ì½ìŒ
                    // console.log('ì„œë²„ ì‘ë‹µ:', result2);
                    // ì´ì œ resultì— ì„œë²„ë¡œë¶€í„°ì˜ ì‘ë‹µ ë°ì´í„°ê°€ ìˆìŠµë‹ˆë‹¤.

                    console.log(result2);

                    document.getElementById("result2").innerHTML = "ì „ì†¡ë¨";
                    securitycode.value = result2;
                    // securitycode+=result;
                    // Update the error/success message
                    const echeckError = document.getElementById("echeck-error");
                    const echeckSuccess = document.getElementById("echeck-success");


                    updateSubmitButton();



                } else {
                    // ì„œë²„ ì‘ë‹µì´ ì˜¤ë¥˜ì¸ ê²½ìš°ì˜ ì²˜ë¦¬
                    console.error('ì„œë²„ ì‘ë‹µì´ ì˜¤ë¥˜ ìƒíƒœì…ë‹ˆë‹¤.');
                }
            } catch (error) {
                // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë‚˜ ë‹¤ë¥¸ ì˜ˆì™¸ ì²˜ë¦¬
                console.error('ì˜¤ë¥˜ ë°œìƒ:', error);
            }
        }


        const emailElement = document.querySelector('#email');
        emailElement.addEventListener('focusout', checkEmailAvailability);

        async function checkEmailAvailability() {
            const email = document.querySelector("[name=email]").value;
            var emailPattern = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}$/;

            if (!emailPattern.test(email)) {
                document.getElementById("email-error").textContent = "ì˜¬ë°”ë¥¸ email í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.";
                document.getElementById("email-success").textContent = '';
                document.getElementById("emailcheckButton").disabled = true;
            } else {
                const response = await fetch(`/checkEmailAvailability?email=${email}`);
                const result = await response.text();
                if (result === "ê°€ì…ë¶ˆê°€") {
                    document.getElementById("email-error").textContent = "ì¤‘ë³µëœ ì´ë©”ì¼ ì£¼ì†Œì…ë‹ˆë‹¤.";
                    document.getElementById("email-success").textContent = '';
                    document.getElementById("emailcheckButton").disabled = true;
                } else {
                    document.getElementById("email-error").textContent = "";
                    document.getElementById("email-success").textContent = 'ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.';
                    document.getElementById("emailcheckButton").disabled = false;
                }
                console.log(textContent);
                updateSubmitButton();
            }
        }

        async function validateEcheck() {
            const check = document.querySelector("[name=echeck]").value;
            const echeck = document.querySelector("#echeck");

            if (echeck.style.display !== 'none' && echeck.value === securitycode.value) {
                document.getElementById("echeck-error").textContent = "";
                document.getElementById("echeck-success").textContent = "í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.";
            } else {
                document.getElementById("echeck-error").textContent = "ì¸ì¦ ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ í™•ì¸í•´ ì£¼ì„¸ìš”.";
                document.getElementById("echeck-success").textContent = "";
            }

            updateSubmitButton();
        }
        

        async function validatePw() {
            const pw = document.querySelector("[name=pw]").value;
            var pwPattern = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;

            if (!pwPattern.test(pw)) {
                document.getElementById("pw-error").textContent = "ë¹„ë°€ë²ˆí˜¸ëŠ” ì˜ë¬¸, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ìë¥¼ ëª¨ë‘ í¬í•¨í•˜ê³  8ìë¦¬ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.";
                document.getElementById("pw-success").textContent = "";
            } else {
                document.getElementById("pw-error").textContent = "";
                document.getElementById("pw-success").textContent = 'ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.';
            }

            updateSubmitButton();
        }

        function validatePhone() {
            const phone = document.querySelector("[name=phone]").value;

            if (phone.length !== 11) {
                document.getElementById("phone-error").textContent = "í•¸ë“œí° ë²ˆí˜¸ëŠ” 11ìë¦¬ì—¬ì•¼ í•©ë‹ˆë‹¤.";
            } else {
                document.getElementById("phone-error").textContent = "";
            }

            updateSubmitButton();
        }

        function validateMonth(monthField, event) {
            var value = monthField.value.trim();
            var numericValue = parseInt(value);

            if (value === '' || (numericValue >= 1 && numericValue <= 12)) {
                // ì…ë ¥ê°’ì´ ë¹„ì–´ ìˆê±°ë‚˜ ì§€ì •ëœ ë²”ìœ„ ë‚´ì— ìˆì„ ë•ŒëŠ” ì•„ë¬´ëŸ° ì‘ì—…ì„ ìˆ˜í–‰í•˜ì§€ ì•ŠìŒ
                return;
            }

            // ì…ë ¥ê°’ì´ ë¹ˆ ì¹¸ì´ ì•„ë‹ˆê³  1ë¶€í„° 12 ë²”ìœ„ë¥¼ ë²—ì–´ë‚  ë•Œë§Œ ì•Œë¦¼ì°½ì„ í‘œì‹œ
            alert("ì›”ì€ 1ë¶€í„° 12ê¹Œì§€ì˜ ìˆ«ìë§Œ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            monthField.value = "";

            if (event) event.stopPropagation();
            updateSubmitButton();
        }

        function validateDay(dayField, event) {
            var value = dayField.value.trim();
            var numericValue = parseInt(value);

            if (value === '' ||  numericValue >= 0 && numericValue <= 31) {
                // ê°’ì´ ë¹„ì–´ìˆì§€ ì•Šê³  ì§€ì •ëœ ë²”ìœ„ ë‚´ì— ìˆì„ ë•ŒëŠ” ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•ŠìŒ
                return;
            }

            // ì…ë ¥ê°’ì´ ë¹„ì–´ ìˆê±°ë‚˜ ë²”ìœ„ë¥¼ ë²—ì–´ë‚  ë•Œë§Œ ì•Œë¦¼ì°½ ë„ìš°ê¸°
            alert("ì¼ì€ 1ë¶€í„° 31ê¹Œì§€ì˜ ìˆ«ìë§Œ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            dayField.value = "";

            if (event) event.stopPropagation();
            updateSubmitButton();
        }

        function updateBirth() {
            const yy = document.querySelector("[name=yy]").value;
            const mm = document.querySelector("[name=mm]").value;
            const dd = document.querySelector("[name=dd]").value;
            const birth = `${yy}-${mm}-${dd}`;

            // "h1" íƒœê·¸ì— ë‚ ì§œ ì •ë³´ ì¶”ê°€
            document.getElementById("birth").textContent = `ìƒë…„ì›”ì¼: ${birth}`;
            updateSubmitButton();

        }

        //         function emailcheck() {
        //     const emailError = document.getElementById("email-error").textContent;
        //     const emailCheckButton = document.getElementById("emailcheckButton");

        //     if (emailError === 'ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.') {
        //         emailCheckButton.disabled = false;
        //     } else {
        //         emailCheckButton.disabled = true;
        //     }
        // }

        function updateSubmitButton() {
            const echeckError = document.getElementById("echeck-error").textContent;
            const emailError = document.getElementById("email-error").textContent;
            const pwError = document.getElementById("pw-error").textContent;
            const phoneError = document.getElementById("phone-error").textContent;
            const datacheck = document.getElementById("echeck-success").textContent;

            if (emailError === "" && pwError === "" && phoneError === "" && echeckError === "") {
                // ëª¨ë“  ìœ íš¨ì„± ê²€ì‚¬ë¥¼ í†µê³¼í•˜ê³  ì´ë©”ì¼ í™•ì¸ì´ "í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤"ì¼ ë•Œ ê°€ì… ë²„íŠ¼ í™œì„±í™”
                if (datacheck === "í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.") {
                    document.getElementById("signupButton").disabled = false;
                } else {
                    document.getElementById("signupButton").disabled = true;
                }
            } else {
                // í•˜ë‚˜ë¼ë„ ìœ íš¨ì„± ê²€ì‚¬ì— ì‹¤íŒ¨í•˜ê±°ë‚˜ ì´ë©”ì¼ í™•ì¸ì´ "ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”"ì¼ ë•Œ ê°€ì… ë²„íŠ¼ ë¹„í™œì„±í™”
                document.getElementById("signupButton").disabled = true;
            }
        }



        document.addEventListener('DOMContentLoaded', function () {
            const loginButton = document.getElementById('login-button'); // ë¡œê·¸ì¸ ë²„íŠ¼
    const email ="${email}"
    if (email) {
        // ì‚¬ìš©ìê°€ ë¡œê·¸ì¸ ìƒíƒœì¼ ë•Œ
        loginButton.textContent = 'ë¡œê·¸ì•„ì›ƒ';
        loginButton.addEventListener('click', function () {
            // ë¡œê·¸ì•„ì›ƒ ë¡œì§ì„ ìˆ˜í–‰í•  í•¨ìˆ˜ë¥¼ í˜¸ì¶œ (loginOrLogout í•¨ìˆ˜ì™€ ê°™ì€ ì—­í• )
            logout();
        });
    } else {
        // ì‚¬ìš©ìê°€ ë¡œê·¸ì•„ì›ƒ ìƒíƒœì¼ ë•Œ
        loginButton.textContent = 'ë¡œê·¸ì¸';
        loginButton.addEventListener('click', function () {
            // ë¡œê·¸ì¸ ë¡œì§ì„ ìˆ˜í–‰í•  í•¨ìˆ˜ë¥¼ í˜¸ì¶œ (loginOrLogin í•¨ìˆ˜ì™€ ê°™ì€ ì—­í• )
            login();
        });}

            // Sign Up ë²„íŠ¼ì„ í´ë¦­í•  ë•Œ ë¹„ë™ê¸° í†µì‹ ì„ ì‹œì‘í•©ë‹ˆë‹¤.
            var signupButton = document.getElementById("signupButton");
            signupButton.addEventListener("click", function () {
                var xhr = new XMLHttpRequest();
                var form = document.getElementById("signupForm");
                var formData = {
                    email: form["email"].value,
                    name: form["name"].value,
                    pw: form["pw"].value,

                    phone: form["phone"].value,
                    yy: form["yy"].value,
                    dd: form["dd"].value,
                    mm: form["mm"].value



                }

                console.log(formData);
                xhr.open("POST", "/signup", true);
                xhr.setRequestHeader("Content-Type", "application/json");
                xhr.onreadystatechange = function () {
                    if (xhr.readyState === 4) {
                        if (xhr.status === 200) {
                            var response = xhr.responseText;
                            var result = document.getElementById("result");
                            result.innerHTML = "ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.";

                        } else {
                            console.error("ì˜¤ë¥˜ ë°œìƒ:", xhr.statusText);
                        }
                    }
                };

                xhr.send(JSON.stringify(formData));
            });
        });
    </script>
</body>

</html>